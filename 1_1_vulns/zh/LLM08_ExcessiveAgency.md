LLM08: 过度代理(Excessive Agency)
 
基于大语言模型的系统通常被其开发人员授予一定程度的代理权——与其他系统交互并根据提示采取行动的能力。关于调用哪些函数的决定也可以委托给 LLM“代理”，以根据输入提示或 LLM 输出动态确定。
 
过度代理是一种威胁，可以针对 LLM 的意外/模糊输出执行破坏性操作（无论导致 LLM 故障的原因是什么；无论是幻觉/虚构、直接/间接提示注入、恶意插件、不良 -设计的良性提示，或者只是一个表现不佳的模型）。过多代理的根本原因通常是以下一项或多项: 过多的功能、过多的权限或过多的自主权。
 
过多的代理可能会导致机密性、完整性和可用性方面产生广泛的影响，并且取决于基于 LLM 的应用程序能够与哪些系统进行交互。
 
威胁的常见示例
 
1. 过多的功能: LLM 代理可以访问包含系统预期操作不需要的功能的插件。例如，开发人员需要授予 LLM 代理从存储库读取文档的能力，但他们选择使用的第 3 方插件还包括修改和删除文档的能力。或者，某个插件可能已在开发阶段进行过试用，并被放弃以支持更好的替代方案，但原始插件仍然可供 LLM 代理使用。
2. 过多的功能: 具有开放式功能的 LLM 插件无法正确过滤超出应用程序预期操作所需的命令的输入指令。例如，运行一个特定 shell 命令的插件无法正确阻止其他 shell 命令的执行。
3. 过多的权限: LLM 插件在其他系统上拥有应用程序预期操作不需要的权限。例如，旨在读取数据的插件使用不仅具有 SELECT 权限，而且还具有 UPDATE、INSERT 和 DELETE 权限的身份连接到数据库服务器。
4. 过多的权限: LLM插件旨在代表用户执行操作，以通用的高权限身份访问下游系统。例如，用于读取当前用户文档存储的插件使用有权访问所有用户文件的特权帐户连接到文档存储库。
5. 过度自治: 基于 LLM 的应用程序或插件没有被独立验证和批准而运行高影响力的操作。例如，允许删除用户文档的插件无需用户确认即可执行删除。
 
如何预防
 
以下措施可以防止过度代理: 
 
1. 将允许 LLM 代理调用的插件/工具限制为仅必需的最少功能。例如，如果基于 LLM 的系统不需要获取 URL 内容的能力，则不应向 LLM 代理提供此类插件。
2. 将 LLM 插件/工具中实现的功能限制到最低限度。例如，访问用户邮箱来汇总电子邮件的插件可能只需要阅读电子邮件的能力，因此该插件不应包含其他功能，例如删除或发送消息。
3. 尽可能避免开放式函数（例如，运行 shell 命令、获取 URL 等）并使用具有更精细功能的插件/工具。例如，基于 LLM 的应用程序可能需要将一些输出写入文件。如果这是使用插件来运行 shell 函数来实现的，那么不良操作的范围会非常大（可以执行任何其他 shell 命令）。更安全的替代方案是构建一个只能支持该特定功能的文件写入插件。
4. 将 LLM 插件/工具授予其他系统的权限限制为最低限度，以限制不良操作的范围。例如，使用产品数据库向客户提出购买建议的 LLM 代理可能只需要对“产品”表的读取访问权限；它不应该有权访问其他表，也不应该插入、更新或删除记录。这应该通过为 LLM 插件用于连接数据库的身份应用适当的数据库权限来强制执行。
5. 跟踪用户授权和安全范围，以确保代表用户采取的操作在该特定用户的上下文中的下游系统上执行，并具有所需的最低权限。例如，读取用户代码存储库的 LLM 插件应要求用户通过 OAuth 进行身份验证并具有所需的最小范围。
6. 利用人机交互控制要求所有操作在采取之前必须经过人的批准。这可以在下游系统（LLM应用程序范围之外）或LLM插件/工具本身内实现。例如，代表用户创建和发布社交媒体内容的基于 LLM 的应用程序应在实现“发布”操作的插件/工具/API 中包含用户批准例程。
7. 在下游系统中实施授权，而不是依赖大语言模型来决定是否允许某项操作。实施工具/插件时，强制执行完整的中介原则，以便根据安全策略验证通过插件/工具向下游系统发出的所有请求。
 
以下选项不会阻止过度代理，但可以限制造成的损害程度: 
 
1. 记录并监控 LLM 插件/工具和下游系统的活动，以确定不良行为发生的位置，并做出相应的响应。
2. 实施速率限制以减少给定时间段内可能发生的不良行为的数量，从而增加在发生重大损害之前通过监控发现不良行为的机会。
 
攻击场景示例
 
基于大语言模型的个人助理应用程序被授予通过插件访问个人邮箱的权限，以总结传入电子邮件的内容。为了实现此功能，电子邮件插件需要能够读取消息，但是系统开发人员选择使用的插件还包含发送消息的功能。 LLM 容易受到间接提示注入攻击，恶意制作的传入电子邮件会欺骗 LLM 命令电子邮件插件调用“发送消息”功能，从用户邮箱发送垃圾邮件。这可以通过以下方式避免: (a) 通过使用仅提供邮件阅读功能的插件来消除过多的功能，(b) 通过具有只读范围的 OAuth 会话对用户的电子邮件服务进行身份验证来消除过多的权限，和/ (c) 通过要求用户手动查看 LLM 插件起草的每封邮件并点击“发送”来消除过多的自主权。或者，可以通过对邮件发送接口实施速率限制来减少造成的损害。
 
参考链接
 
1. ChatGPT Plugin Exploit Explained: From Prompt Injection to Accessing Private Data:  https://embracethered.com/blog/posts/2023/chatgpt-cross-plugin-request-forgery-and-prompt-injection./
2. NeMo-Guardrails 接口指南:  https://github.com/NVIDIA/NeMo-Guardrails/blob/main/docs/security/guidelines.md
3. LangChain: 工具的人工认可:  https://python.langchain.com/docs/modules/agents/tools/ human_approval
4. 西蒙·威利森: 双大语言模型模式:  https://simonwillison.net/2023/Apr/25/dual-llm-pattern/
